<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome Tree Tab Manager</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            background: #fff;
            overflow: hidden;
        }

        #app {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            background: #f5f5f5;
        }

        .header h1 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #202124;
        }

        .search-bar {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        .search-input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .main {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .tree-node {
            display: flex;
            align-items: center;
            height: 32px;
            padding: 0 8px;
            margin: 1px 4px;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
            border-radius: 4px;
        }

        .tree-node:hover {
            background: #f1f3f4;
        }

        .tree-node.active {
            background: #e8f0fe;
            font-weight: 500;
        }

        .tree-node.loading {
            opacity: 0.7;
        }

        .collapse-button {
            width: 20px;
            height: 20px;
            margin-right: 4px;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            border-radius: 2px;
            font-size: 10px;
            color: #5f6368;
        }

        .collapse-button:hover {
            background: #dadce0;
        }

        .collapse-placeholder {
            width: 20px;
            height: 20px;
            margin-right: 4px;
        }

        .node-favicon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .node-title {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
            color: #202124;
        }

        .tree-node.active .node-title {
            color: #1967d2;
        }

        .node-icons {
            display: flex;
            gap: 4px;
            margin-left: 8px;
            font-size: 12px;
        }

        .children-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 18px;
            padding: 0 6px;
            margin-left: 8px;
            background: #e8eaed;
            border-radius: 9px;
            font-size: 11px;
            font-weight: 500;
            color: #5f6368;
        }

        .footer {
            padding: 8px 16px;
            border-top: 1px solid #e0e0e0;
            background: #f5f5f5;
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #5f6368;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #80868b;
            font-size: 14px;
        }

        /* ÊªöÂä®Êù° */
        .main::-webkit-scrollbar {
            width: 8px;
        }

        .main::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .main::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .main::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="header">
            <h1>üå≤ Chrome Tree Tab Manager</h1>
        </div>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="ÊêúÁ¥¢Ê†áÁ≠æÈ°µ..." id="searchInput" />
        </div>

        <div class="main" id="treeContainer"></div>

        <div class="footer">
            <span id="tabCount">Ê†áÁ≠æÈ°µ: 0</span>
            <span id="windowCount">Á™óÂè£: 0</span>
        </div>
    </div>

    <script type="module">
        // ÁÆÄÂçïÁöÑÊ†ëÁä∂ÁªìÊûÑÁÆ°ÁêÜ
        let tabs = [];
        let windows = [];
        let collapsedNodes = new Set();
        let searchQuery = '';
        let activeTabId = null;

        // ÂàùÂßãÂåñ
        async function init() {
            console.log('üöÄ Chrome Tree Tab Manager ÂêØÂä®');

            // Âä†ËΩΩÊ†áÁ≠æÈ°µ
            await loadTabs();
            await loadWindows();

            // Ê∏≤ÊüìÊ†ë
            renderTree();

            // ËÆæÁΩÆÁõëÂê¨Âô®
            setupListeners();

            console.log('‚úÖ ÂàùÂßãÂåñÂÆåÊàê');
        }

        // Âä†ËΩΩÊ†áÁ≠æÈ°µ
        async function loadTabs() {
            try {
                const allTabs = await chrome.tabs.query({});
                console.log('üìä Âä†ËΩΩ‰∫Ü', allTabs.length, '‰∏™Ê†áÁ≠æÈ°µ');

                // ËΩ¨Êç¢‰∏∫Ê†ëÁªìÊûÑ
                tabs = allTabs.map(tab => ({
                    id: tab.id,
                    tabId: tab.id,
                    windowId: tab.windowId,
                    title: tab.title || 'Untitled',
                    url: tab.url || '',
                    favicon: tab.favIconUrl || '',
                    isActive: tab.active,
                    isPinned: tab.pinned,
                    isLoading: tab.status === 'loading',
                    isAudioPlaying: tab.audible || false,
                    parentId: tab.openerTabId || null,
                    children: [],
                    depth: 0
                }));

                // ÊûÑÂª∫Áà∂Â≠êÂÖ≥Á≥ª
                buildTree();

            } catch (error) {
                console.error('‚ùå Âä†ËΩΩÊ†áÁ≠æÈ°µÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÁ™óÂè£
        async function loadWindows() {
            try {
                const allWindows = await chrome.windows.getAll();
                windows = allWindows;
                console.log('ü™ü Âä†ËΩΩ‰∫Ü', windows.length, '‰∏™Á™óÂè£');
            } catch (error) {
                console.error('‚ùå Âä†ËΩΩÁ™óÂè£Â§±Ë¥•:', error);
            }
        }

        // ÊûÑÂª∫Ê†ëÁªìÊûÑ
        function buildTree() {
            // Âª∫Á´ã ID Êò†Â∞Ñ
            const tabMap = new Map();
            tabs.forEach(tab => tabMap.set(tab.id, tab));

            // ÊûÑÂª∫Áà∂Â≠êÂÖ≥Á≥ª
            tabs.forEach(tab => {
                if (tab.parentId && tabMap.has(tab.parentId)) {
                    const parent = tabMap.get(tab.parentId);
                    if (!parent.children.includes(tab)) {
                        parent.children.push(tab);
                    }
                    tab.depth = parent.depth + 1;
                }
            });
        }

        // Ê∏≤ÊüìÊ†ë
        function renderTree() {
            const container = document.getElementById('treeContainer');
            const tabCountEl = document.getElementById('tabCount');
            const windowCountEl = document.getElementById('windowCount');

            // Êõ¥Êñ∞ÁªüËÆ°
            tabCountEl.textContent = `Ê†áÁ≠æÈ°µ: ${tabs.length}`;
            windowCountEl.textContent = `Á™óÂè£: ${windows.length}`;

            // ËøáÊª§ÂíåÊéíÂ∫è
            const query = searchQuery.toLowerCase();
            const visibleTabs = tabs.filter(tab => {
                if (!query) return !tab.parentId; // Âè™ÊòæÁ§∫Ê†πËäÇÁÇπ
                return tab.title.toLowerCase().includes(query) ||
                    tab.url.toLowerCase().includes(query);
            });

            // Â¶ÇÊûúÊ≤°ÊúâÊ†áÁ≠æÈ°µ
            if (visibleTabs.length === 0) {
                container.innerHTML = '<div class="empty-state">Ê≤°ÊúâÊâæÂà∞Ê†áÁ≠æÈ°µ</div>';
                return;
            }

            // Ê∏≤ÊüìËäÇÁÇπ
            container.innerHTML = '';
            visibleTabs.forEach(tab => {
                renderNode(tab, container);
            });
        }

        // Ê∏≤ÊüìÂçï‰∏™ËäÇÁÇπ
        function renderNode(tab, container) {
            const node = document.createElement('div');
            node.className = 'tree-node' + (tab.isActive ? ' active' : '') + (tab.isLoading ? ' loading' : '');
            node.style.paddingLeft = `${8 + tab.depth * 20}px`;
            node.dataset.tabId = tab.id;

            // ÊäòÂè†ÊåâÈíÆ
            if (tab.children.length > 0) {
                const collapseBtn = document.createElement('button');
                collapseBtn.className = 'collapse-button';
                collapseBtn.textContent = collapsedNodes.has(tab.id) ? '‚ñ∂' : '‚ñº';
                collapseBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleCollapse(tab.id);
                };
                node.appendChild(collapseBtn);
            } else {
                const placeholder = document.createElement('span');
                placeholder.className = 'collapse-placeholder';
                node.appendChild(placeholder);
            }

            // Favicon
            if (tab.favicon) {
                const favicon = document.createElement('img');
                favicon.className = 'node-favicon';
                favicon.src = tab.favicon;
                favicon.onerror = () => favicon.textContent = 'üåê';
                node.appendChild(favicon);
            } else {
                const placeholder = document.createElement('span');
                placeholder.className = 'node-favicon';
                placeholder.textContent = 'üåê';
                node.appendChild(placeholder);
            }

            // Ê†áÈ¢ò
            const title = document.createElement('span');
            title.className = 'node-title';
            title.textContent = tab.title;
            node.appendChild(title);

            // Â≠êËäÇÁÇπÊï∞Èáè
            if (collapsedNodes.has(tab.id) && tab.children.length > 0) {
                const count = document.createElement('span');
                count.className = 'children-count';
                count.textContent = tab.children.length;
                node.appendChild(count);
            }

            // Áä∂ÊÄÅÂõæÊ†á
            const icons = document.createElement('div');
            icons.className = 'node-icons';
            if (tab.isLoading) icons.innerHTML += '‚è≥';
            if (tab.isAudioPlaying) icons.innerHTML += 'üîä';
            if (tab.isPinned) icons.innerHTML += 'üìå';
            node.appendChild(icons);

            // ÁÇπÂáª‰∫ã‰ª∂
            node.onclick = () => activateTab(tab.id);

            container.appendChild(node);

            // Ê∏≤ÊüìÂ≠êËäÇÁÇπ
            if (!collapsedNodes.has(tab.id) && tab.children.length > 0) {
                tab.children.forEach(child => renderNode(child, container));
            }
        }

        // ÊøÄÊ¥ªÊ†áÁ≠æÈ°µ
        async function activateTab(tabId) {
            try {
                const tab = tabs.find(t => t.id === tabId);
                if (tab) {
                    await chrome.tabs.update(tabId, { active: true });
                    await chrome.windows.update(tab.windowId, { focused: true });
                    activeTabId = tabId;
                    await loadTabs();
                    renderTree();
                }
            } catch (error) {
                console.error('ÊøÄÊ¥ªÊ†áÁ≠æÈ°µÂ§±Ë¥•:', error);
            }
        }

        // ÂàáÊç¢ÊäòÂè†Áä∂ÊÄÅ
        function toggleCollapse(tabId) {
            if (collapsedNodes.has(tabId)) {
                collapsedNodes.delete(tabId);
            } else {
                collapsedNodes.add(tabId);
            }
            renderTree();
        }

        // ËÆæÁΩÆÁõëÂê¨Âô®
        function setupListeners() {
            // ÊêúÁ¥¢ËæìÂÖ•
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value;
                renderTree();
            });

            // Ê†áÁ≠æÈ°µÂèòÂåñÁõëÂê¨
            chrome.tabs.onCreated.addListener(async () => {
                await loadTabs();
                renderTree();
            });

            chrome.tabs.onRemoved.addListener(async () => {
                await loadTabs();
                renderTree();
            });

            chrome.tabs.onUpdated.addListener(async (tabId, changeInfo) => {
                if (changeInfo.status === 'complete' || changeInfo.title) {
                    await loadTabs();
                    renderTree();
                }
            });

            chrome.tabs.onActivated.addListener(async () => {
                await loadTabs();
                renderTree();
            });

            console.log('‚úÖ ÁõëÂê¨Âô®ËÆæÁΩÆÂÆåÊàê');
        }

        // ÂêØÂä®Â∫îÁî®
        init();
    </script>
</body>

</html>